<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify my account</title>
    <link rel="icon" type="image/x-icon" href="https://i.pinimg.com/736x/68/3d/8f/683d8f58c98a715130b1251a9d59d1b9.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        * {
            -webkit-tap-highlight-color: transparent;
            font-family: 'Poppins', sans-serif;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #000;
            color: #e0e0e0;
            letter-spacing: 0.5px;
        }
::-webkit-scrollbar{
  background-color: transparent;
}
        /* PASSWORD */
        #passwordContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100%;
            text-align: center;
            line-height: 15px;
            position: fixed;
        }

        #userPassword {
            font-size: 16px;
            border-radius: 40px;
            border: none;
            background: #ffffff21;
            color: #fff;
            padding: 9px 25px;
            text-align: center;
            width: 90%;
            outline: none;
            max-width: 300px;
            margin: 21px;
        }

        #userPassword:focus { background: #3c3c3c; }

        #submitBtn {
            width: 40px;
            height: 40px;
            background-color: #ffffff;
            color: #000000;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        #error-message { color: #ff0000; font-size: 12px; margin-top: 10px; }

        .notice {
            font-weight: 200;
            font-size: 12px;
            line-height: 20px;
            position: fixed;
            bottom: 35px;
            color: #ffffff;
            padding: 10px;
            border: solid 1.5px #0043ff;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            padding: 65px 0 0 24px;
            overflow-y: auto;
            z-index: 10;
        }

        .close-btn {
            position: fixed;
            top: 21px;
            left: 20px;
            color: #e0e0e0;
            font-size: 17px;
            cursor: pointer;
            z-index: 11;
            background: #282828;
            padding: 10px 11px;
            border-radius: 50px;
        }

        .fixed {
            position: fixed;
    top: 0;
    padding: 80px 35px 0px 20px;
    left: 0;
    background: transparent;
    width: 108%;
    backdrop-filter: blur(5px);
    z-index: 10;
    border-bottom: 1.5px solid #ffffff3d;
        }

        .scroll {
            position: relative;
            top: 250px;
            padding-bottom: 120px;
        }

        /* PROFILE */
        .profile-container {
            display: flex
;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 0px;
    flex-wrap: wrap;
    flex-direction: column;
        }

        .user-name-container {
            display: flex
;
    align-items: center;
    gap: 8px;
    margin-bottom: -15px;
        }

        #userEmote {
            width: 32px;
            height: 32px;
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        #userEmote:hover { transform: scale(1.1); }

        /* LINKS */
        .user-links {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
               margin: 24px 0px 10px 0px;

        }

        .user-link {
            background: #2a2a2a;
            color: #00aaff;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .add-link-btn {
            background: #004fff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            cursor: pointer;
        }

        /* SEARCH + AMOUNT BUTTONS */
        .search-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            transition: all 0.4s ease;
        }

        #searchIcon {
            font-size: 18px;
            color: #00fff2;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        #searchInput {
           width: 0;
    padding: 0;
    border: none;
    background: #0000003c;
    color: #e0e0e0;
    font-size: 12px;
    border-radius: 20px;
    outline: none;
    transition: all 0.4s 
ease;
    overflow: hidden;
    border: solid 1.5px #ffffff3d;
        }

        #searchInput.active {
            width: 180px;
            padding: 9px 14px;
        }

        .amount-buttons {
           display: flex
;
    gap: 10px;
    overflow-x: auto;
    width: 100%;
    white-space: nowrap;
    padding: 10px 0;
    transition: transform 0.4s 
ease;
    position: relative;
    top: 6.5px;
        }
        h3{
                color: #004fff;
        }
        p {
    margin-bottom: 15px;
    color: #ffffff82;
    font-weight: 400;
    font-size: 15px;
}
        .amount-btn {
            color: #e0e0e0;
    border: none;
    border-radius: 35px;
    padding: 2px 5px;
    font-size: 12px;
    cursor: pointer;
    background: transparent;
    border: 1.5px solid #3a3a3a;
    position: relative;
    min-width: 100px;
    text-align: center;
    transition: all 0.3s 
ease;
    display: flex
;
    justify-content: center;
    align-items: center;
    flex-direction: column;
        }

        .amount-btn.active {
            background-color: #004fff;
    border: 1.5px solid #ffffff00;
    color: white;
        }

        .purpose-tag {
            font-size: 9px;
            color: #00fff2;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
        }

        .total-icon {
       color: #ffffff99;
    border-radius: 10px;
    display: flex
;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    cursor: pointer;
    background: #80808059;
    width: 26px;
    height: 32px;

}

        /* POPUPS */
        #totalPopup, #datePopup, #linkConfirmPopup, #emoteChooser {
               display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #1111112b;
    color: #e0e0e0;
    padding: 20px;
    border-radius: 18px;
    max-width: 340px;
    width: 90%;
    z-index: 20000;
    box-shadow: 0 0 40px 100vh rgb(0 0 0 / 71%);
    text-align: left;
    font-size: 14.5px;
    line-height: 1.7;
    border: 1.5px solid #ffffff3d;
    backdrop-filter: blur(10px);

        }

        #totalPopup h3, #datePopup h3, #linkConfirmPopup h3, #emoteChooser h3 {
                margin: 0 0 14px;
    color: #004fff;
    text-align: center;
        }

        #totalPopup button, #datePopup button, #linkConfirmPopup button, #emoteChooser button {
            margin-top: 14px;
            background: #004fff;
            color: white;
            border: none;
            padding: 7px 16px;
            border-radius: 22px;
            cursor: pointer;
        }

        .btn-yes { background: #00ff88; color: #000; }
        .btn-delete { background: #ff4444; color: white; }

        /* EMOTE CHOOSER */
        .emote-grid {
           display: flex
;
    gap: 20px;
    margin: 15px 0;
    flex-direction: column;
    align-items: center;
    height: 200px;
    overflow-y: scroll;
        }
.graphsays{
    display: flex
;
    align-items: center;
}
        .emote-option {
            width: 60px;
            height: 60px;
            cursor: pointer;
            border-radius: 12px;
            transition: 0.2s;
        }

        .emote-option:hover {
            transform: scale(1.15);
            box-shadow: 0 0 15px #004fff;
        }

        /* LOAN CARD */
        .loan-entry {
           padding: 0px;
    border-radius: 16px;
    position: relative;
    width: 92%;
        }

        .purpose-input {
            width: 100%;
            padding: 10px;
            margin: 12px 0;
            background: #222;
            border: none;
            border-radius: 10px;
            color: #e0e0e0;
            font-size: 14px;
        }

        /* BOTTOM NAV */
        #bottomNav {
            position: fixed;
    bottom: 0px;
    left: 0px;
    background: #1a1a1a00;
    border-radius: 0px;
    padding: 20px 25px;
    display: flex
;
    box-shadow: none;
    z-index: 1000;
    backdrop-filter: blur(10px);
    border-top: 1.5px solid #ffffff1f;
    width: 100%;
    display: flex
;
    justify-content: space-between;
        }

        .nav-item {
    display: flex
;
    align-items: center;
    gap: 5px;
    color: #888;
    font-size: 12px;
    cursor: pointer;
}

        .nav-item.active { color: #00fff2; }
        .nav-item i { font-size: 19px; }

        .toggle-pin {
            font-size: 15px;
            color: #555;
            cursor: pointer;
        }

        .toggle-pin.on { color: #004fff; }

        /* GRAPH & CALENDAR */
        #graphContainer, #calendarContainer {
            background: #111;
    border-radius: 16px;
    padding: 18px;
    margin: 18px 0;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.7);
    border: 1px solid #222;
    position: absolute;
    top: 15px;
    transform: translateX(-50%);
    left: 46.5%;
    width: 100%;
    max-width: 335px;
        }

        #calendarContainer > div > div {
            color: #ddd;
            border-radius: 50%;
            min-height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <!-- PASSWORD -->
    <div id="passwordContainer">
        <h2 style="font-weight: 400; font-size: 20px; color: white;">Verify my account</h2>
        <input type="text" id="userPassword" placeholder="Enter password">
        <button id="submitBtn"><i class="fa-solid fa-arrow-right"></i></button><br>
        <p id="error-message"></p>
        <div class="notice">You should return the money before the due date, If not additional interest will be charged.</div>
    </div>

    <!-- MAIN MODAL -->
    <div id="userInfoModal" class="modal">
        <span><i class="fa-solid fa-arrow-left close-btn" onclick="closeModal()"></i></span>

        <div class="fixed">
            <h3 style="    text-decoration: underline;
    margin: 4px 0;
    font-weight: 400;
    font-size: 10px;
    text-align: left;
    color: #ffffff82;">Borrower</h3>
            <div class="profile-container">
                <div class="user-name-container">
                    <img id="userEmote" src="https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_7d7473ef8ba54ce2b2f8e29d078f90bf/default/dark/2.0" onclick="openEmoteChooser()">
                    <span id="userName" style="font-size:20px;"></span>
                    <div class="total-icon" onclick="showTotalPopup()">
                        <i class="fa-solid fa-calculator"></i>
                    </div>
                </div>
                <div>
                    <div class="user-links" id="userLinks"></div>
                    <button class="add-link-btn" onclick="addLink()">+ Add Link</button>
                </div>
            </div>

            <!-- SEARCH + AMOUNT BUTTONS -->
            <div class="search-container">
                <i id="searchIcon" class="fa-solid fa-magnifying-glass" onclick="toggleSearch()"></i>
                <input type="text" id="searchInput" placeholder="Search amount, purpose..." oninput="filterLoans()">
                <div class="amount-buttons" id="amountButtons"></div>
            </div>
        </div>

        <div class="scroll">
            <div id="loanDetails"></div>
            <div id="graphContainer" style="display:none;"><canvas id="loanChart"></canvas>
            <div class="explain" style="    font-size: 12px;
    line-height: 35px;
    color: #ffffff8a;"><br>
                <div class="graphsays">
                    <span style="    background-color: #f44336;
                        padding: 10px;
                        position: relative;
                        width: 10px;
                        height: 10px;
                        float: left;
                        left: -5px;
                    "></span> Very near for return date<br>
                </div>
                <div class="graphsays">
                    <span style="    background-color: #004fff;
                        padding: 10px;
                        position: relative;
                        width: 10px;
                        height: 10px;
                        float: left;
                        left: -5px;"></span> Middel for return date<br>
                </div>
                <div class="graphsays">
                    <span style="    background-color: #4caf50;
                        padding: 10px;
                        position: relative;
                        width: 10px;
                        height: 10px;
                        float: left;
                        left: -5px;"></span> Very far for return date<br>
                </div>
            </div>
            </div>
            <div id="calendarContainer" style="display:none;"></div>
        </div>
        <div id="bottomNav">
        <div class="nav-item active" data-view="list"><i class="fa-solid fa-list"></i><span>List</span><i class="fa-solid fa-toggle-on toggle-pin on" data-view="list"></i></div>
        <div class="nav-item" data-view="graph"><i class="fa-solid fa-chart-bar"></i><span>Graph</span><i class="fa-solid fa-toggle-off toggle-pin" data-view="graph"></i></div>
        <div class="nav-item" data-view="calendar"><i class="fa-solid fa-calendar"></i><span>Calendar</span><i class="fa-solid fa-toggle-off toggle-pin" data-view="calendar"></i></div>
    </div>
    </div>

    <!-- POPUPS -->
    <div id="totalPopup">
        <h3>Total Summary</h3>
        <div id="totalContent"></div>
        <button onclick="closeTotalPopup()">Close</button>
    </div>

    <div id="datePopup">
        <i class="fa-solid fa-xmark" style="position:absolute;top:10px;right:14px;cursor:pointer;color:#aaa;" onclick="closeDatePopup()"></i>
        <h3>Loan Due</h3>
        <div id="popupContent"></div>
    </div>

    <div id="linkConfirmPopup">
        <p id="linkConfirmText"></p>
        <button class="btn-yes" id="linkYesBtn">Yes</button>
        <button class="btn-delete" id="linkDeleteBtn">Delete</button>
    </div>

    <div id="emoteChooser">
        <h3 style="color:#004fff;">Choose Your Emote</h3>
        <div class="emote-grid">
            <img class="emote-option" src="https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_8b4dd96ec6e6475da4bb1d7887bed076/default/dark/3.0" onclick="setUserEmote(this.src)">
            <img class="emote-option" src="https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_e16d7b2c6d734bfb810a3e7cc7ba2af1/default/dark/3.0" onclick="setUserEmote(this.src)">
            <img class="emote-option" src="https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_b308322f860543f78e046294a9614c68/default/dark/3.0" onclick="setUserEmote(this.src)">
            <img class="emote-option" src="https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_e41e4d6808224f25ae1fb625aa26de63/default/dark/2.0" onclick="setUserEmote(this.src)">
            <img class="emote-option" src="https://static-cdn.jtvnw.net/emoticons/v2/822112/default/dark/2.0" onclick="setUserEmote(this.src)">
            <img class="emote-option" src="https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_fe76f5cb420643b5b7e847db8128933e/default/dark/2.0" onclick="setUserEmote(this.src)">
            <img class="emote-option" src="https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_d3e6ab117dcf4a04911db2d677cd5f6a/default/dark/2.0" onclick="setUserEmote(this.src)">
            <img class="emote-option" src="https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_9bfe7d5290f4493bab89d3b65fda59bf/default/dark/2.0" onclick="setUserEmote(this.src)">
            <img class="emote-option" src="https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_cb51b79464454f26a41fbfa454122b93/default/dark/2.0" onclick="setUserEmote(this.src)">
            <img class="emote-option" src="https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_ba85359f135c4585b26f7d840f0614a7/default/dark/2.0" onclick="setUserEmote(this.src)">
            <img class="emote-option" src="https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_8b494932c0074011922e59a5b9adeb9b/default/dark/2.0" onclick="setUserEmote(this.src)">
            <img class="emote-option" src="https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_a4c2bf9901a243fbb62e2f95b3e42427/default/dark/2.0" onclick="setUserEmote(this.src)">
        </div>
        <button onclick="closeEmoteChooser()">Close</button>
    </div>


    <script>
        // === DATA ===
        const passwords = {
            "0212": {
                name: "Tony Mantana",
                loans: [
                    {
                planDate: "10-08-2025",
                // endDate: "21-10-2025",
                endDate: "25-08-2025",
                interest: 1360,
                takenAmount: 5000,
                takenFrom: "MLLD",
                fineRate: 86
            },
            {
                planDate: "15-08-2025",
                endDate: "30-08-2025",
                interest: 4800,
                takenAmount: 20000,
                takenFrom: "MLending",
                fineRate: 320
            },
            {
                planDate: "16-08-2025",
                endDate: "31-08-2025",
                interest: 1275,
                takenAmount: 5000,
                takenFrom: "MLLD",
                fineRate: 90
            },   
            {
                planDate: "18-08-2025",
                endDate: "02-09-2025",
                interest: 1380,
                takenAmount: 5000,
                takenFrom: "MLLD",
                fineRate: 88
            },
            {
                planDate: "18-08-2025",
                endDate: "02-09-2025",
                interest: 690,
                takenAmount: 2500,
                takenFrom: "MLLD",
                fineRate: 46
            },
            {
                planDate: "13-10-2025",
                endDate: "28-10-2025",
                interest: 0,
                takenAmount: 10000,
                takenFrom: "MLending",
                fineRate: 46
            },
            {
                planDate: "14-10-2025",
                endDate: "29-10-2025",
                interest: 0,
                takenAmount: 2700,
                takenFrom: "MLLD",
                fineRate: 46
            },  
            {
                planDate: "23-10-2025",
                endDate: "07-11-2025",
                interest: 1320,
                takenAmount: 4000,
                takenFrom: "MLLD",
                fineRate: 46
            }, 
                ],
                links: [],
                emote: "https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_7d7473ef8ba54ce2b2f8e29d078f90bf/default/dark/2.0"
            }
        };

        let currentUser = null, currentLoanIndex = null, loanChart = null, calendarMonth = new Date();
        const PINNED_KEY = 'pinnedView';
        let pendingLink = null;
        let filteredLoans = [];

        // === LOAD DATA ===
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('lastPassword');
            if (saved) setTimeout(() => document.getElementById("userPassword").value = saved, 300);
            loadUserData();
        });

        function loadUserData() {
            const data = JSON.parse(localStorage.getItem('userData')) || {};
            for (let k in passwords) {
                if (data[k]) {
                    passwords[k].links = data[k].links || [];
                    passwords[k].emote = data[k].emote || passwords[k].emote;
                    passwords[k].loans.forEach((loan, i) => loan.purpose = data[k].purposes?.[i] || "");
                }
            }
        }

        function saveUserData() {
            const data = {};
            for (let k in passwords) {
                data[k] = {
                    links: passwords[k].links,
                    emote: passwords[k].emote,
                    purposes: passwords[k].loans.map(l => l.purpose)
                };
            }
            localStorage.setItem('userData', JSON.stringify(data));
        }

        // === LOGIN ===
        document.getElementById("submitBtn").onclick = () => {
            const input = document.getElementById("userPassword").value.trim();
            const user = passwords[input];
            const err = document.getElementById("error-message");

            localStorage.setItem('lastPassword', input);

            if (user) {
                currentUser = user;
                filteredLoans = [...user.loans];
                document.getElementById("userName").textContent = user.name;
                document.getElementById("userEmote").src = user.emote;

                renderLinks();
                renderAmountButtons();
                if (user.loans.length) displayLoanDetails(user.loans[0], 0);

                document.getElementById("userInfoModal").style.display = "block";
                err.textContent = "";

                const pinned = localStorage.getItem(PINNED_KEY) || 'list';
                switchView(pinned, false);
                updateNavActive(pinned);
            } else {
                err.textContent = "Invalid password!";
            }
        };

        // === SEARCH ANIMATION ===
        let searchOpen = false;
        function toggleSearch() {
            const input = document.getElementById("searchInput");
            const icon = document.getElementById("searchIcon");
            const buttons = document.getElementById("amountButtons");

            searchOpen = !searchOpen;
            if (searchOpen) {
                input.classList.add("active");
                icon.style.transform = "rotate(90deg)";
                buttons.style.transform = "translateY(0px)";
                setTimeout(() => input.focus(), 300);
            } else {
                input.classList.remove("active");
                icon.style.transform = "rotate(0deg)";
                buttons.style.transform = "translateY(0)";
                input.value = "";
                filterLoans();
            }
        }

        function filterLoans() {
            const query = document.getElementById("searchInput").value.toLowerCase();
            filteredLoans = currentUser.loans.filter(loan =>
                loan.takenAmount.toString().includes(query) ||
                (loan.purpose && loan.purpose.toLowerCase().includes(query)) ||
                loan.takenFrom.toLowerCase().includes(query)
            );
            renderAmountButtons();
        }

        // === RENDER BUTTONS ===
        function renderAmountButtons() {
            const btns = document.getElementById("amountButtons");
            btns.innerHTML = "";
            filteredLoans.forEach((loan, i) => {
                const originalIndex = currentUser.loans.indexOf(loan);
                const b = document.createElement("button");
                b.className = "amount-btn";
                b.innerHTML = `
                    ${loan.takenAmount} Rs.
                    <div class="purpose-tag">${loan.purpose || 'Set Purpose'}</div>
                `;
                b.onclick = () => { displayLoanDetails(loan, originalIndex); switchView('list', false); };
                btns.appendChild(b);
            });
        }

        // === DISPLAY LOAN DETAILS ===
        function displayLoanDetails(loan, index) {
            currentLoanIndex = index;
            const now = new Date();
            const end = new Date(loan.endDate.split('-').reverse().join('-'));
            const daysLeft = Math.ceil((end - now) / 86400000);
            let total = loan.takenAmount + loan.interest;
            let extra = 0;
            if (now > end) {
                const hrs = Math.floor((now - end) / 36000000);
                extra = hrs * 30;
                total += extra;
            }

            document.querySelectorAll(".amount-btn").forEach(b => b.classList.remove("active"));
            const activeBtn = document.getElementById("amountButtons").children[
                filteredLoans.indexOf(loan)
            ];
            if (activeBtn) activeBtn.classList.add("active");

            document.getElementById("loanDetails").innerHTML = `
                <div class="loan-entry" id="loanCard${index}">
                    <h3 style="text-decoration: underline; margin: 25px 0; font-weight: 600; font-size: 15px;">Purpose</h3>
                    <input type="text" class="purpose-input" placeholder="e.g. Taken for shoes" value="${loan.purpose || ''}" onchange="updatePurpose(${index}, this.value)">
                    <h3 style="text-decoration: underline; margin: 25px 0; font-weight: 600; font-size: 15px;">Taken service</h3>
                    <p>${loan.takenFrom}</p>
                    <h3 style="text-decoration: underline; margin: 25px 0; font-weight: 600; font-size: 15px;">Amount taken</h3>
                    <p><i class="fa-solid fa-money-bill-transfer"></i> ${loan.takenAmount} Rupees</p>
                    <h3 style="text-decoration: underline; margin: 25px 0; font-weight: 600; font-size: 15px;">Taken & Ends</h3>
                    <p><i class="fa-solid fa-calendar-day"></i> ${loan.planDate}</p>
                    <p><i class="fa-solid fa-calendar-check"></i> ${loan.endDate}</p>
                    <h3 style="text-decoration: underline; margin: 25px 0; font-weight: 600; font-size: 15px;">Interest</h3>
                    <p><i class="fa-solid fa-arrow-up-wide-short"></i> ${loan.interest} Rupees</p>
                    ${extra > 0 ? `<p style="color:#ff0000;"><i class="fa-solid fa-exclamation-circle"></i> Overdue: ${extra} Rupees</p>` : ''}
                    <h3 style="text-decoration: underline; margin: 25px 0; font-weight: 600; font-size: 15px;">Total to Pay</h3>
                    <p><i class="fa-solid fa-money-check-alt"></i> ${total.toFixed(2)} Rupees</p>
                </div>
            `;
        }

        function updatePurpose(index, value) {
            currentUser.loans[index].purpose = value.trim();
            saveUserData();
            filterLoans();
        }

        // === LINKS ===
        function renderLinks() {
            const c = document.getElementById("userLinks"); c.innerHTML = "";
            currentUser.links.forEach((link, i) => {
                const a = document.createElement("div");
                a.className = "user-link";
                a.innerHTML = `<i class="fa-solid fa-link"></i> ${link.title}`;
                a.onclick = () => openLinkConfirm(link, i);
                c.appendChild(a);
            });
        }

        function addLink() {
            const title = prompt("Link title:");
            if (!title) return;
            const url = prompt("Full URL[](https://...):");
            if (url && url.startsWith('http')) {
                currentUser.links.push({ title, url });
                renderLinks();
                saveUserData();
            }
        }

        function openLinkConfirm(link, index) {
            pendingLink = { link, index };
            document.getElementById("linkConfirmText").textContent = `Open "${link.title}"?`;
            document.getElementById("linkConfirmPopup").style.display = "block";
        }

        document.getElementById("linkYesBtn").onclick = () => {
            window.open(pendingLink.link.url, '_blank');
            document.getElementById("linkConfirmPopup").style.display = "none";
        };

        document.getElementById("linkDeleteBtn").onclick = () => {
            currentUser.links.splice(pendingLink.index, 1);
            renderLinks();
            saveUserData();
            document.getElementById("linkConfirmPopup").style.display = "none";
        };

        // === EMOTE CHOOSER ===
        function openEmoteChooser() { document.getElementById("emoteChooser").style.display = "block"; }
        function closeEmoteChooser() { document.getElementById("emoteChooser").style.display = "none"; }
        function setUserEmote(src) {
            currentUser.emote = src;
            document.getElementById("userEmote").src = src;
            saveUserData();
            closeEmoteChooser();
        }

        // === TOTAL POPUP ===
        function showTotalPopup() {
            const now = new Date();
            let base = 0, interest = 0, overdue = 0;
            currentUser.loans.forEach(loan => {
                base += loan.takenAmount;
                interest += loan.interest;
                const end = new Date(loan.endDate.split('-').reverse().join('-'));
                if (now > end) {
                    const hrs = Math.floor((now - end) / 3600000);
                    overdue += hrs * 30;
                }
            });
            const total = base + interest + overdue;

            document.getElementById("totalContent").innerHTML = `
                <p>Base: <strong>${base} Rs.</strong></p>
                <p>Interest: <strong>${interest} Rs.</strong></p>
                <p style="color:#ff0000;">Overdue: <strong>${overdue} Rs.</strong></p>
                <p style="color:#00ff88;">Total: <strong>${total} Rp.</strong></p>
            `;
            document.getElementById("totalPopup").style.display = "block";
        }

        function closeTotalPopup() { document.getElementById("totalPopup").style.display = "none"; }

        // === NAV & VIEWS ===
        function updateNavActive(view) {
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.toggle('active', n.dataset.view === view);
                const pin = n.querySelector('.toggle-pin');
                const isPinned = localStorage.getItem(PINNED_KEY) === n.dataset.view;
                pin.className = `fa-solid fa-toggle-${isPinned ? 'on' : 'off'} toggle-pin ${isPinned ? 'on' : ''}`;
            });
        }

        document.querySelectorAll('.nav-item').forEach(item => {
            item.onclick = () => {
                const view = item.dataset.view;
                switchView(view, true);
            };
        });

        document.querySelectorAll('.toggle-pin').forEach(pin => {
            pin.onclick = (e) => {
                e.stopPropagation();
                const view = pin.dataset.view;
                const current = localStorage.getItem(PINNED_KEY);
                if (current === view) localStorage.removeItem(PINNED_KEY);
                else localStorage.setItem(PINNED_KEY, view);
                updateNavActive(document.querySelector('.nav-item.active').dataset.view);
            };
        });

        function switchView(view, changeNav = true) {
            document.getElementById('loanDetails').style.display = view === 'list' ? 'block' : 'none';
            const graph = document.getElementById('graphContainer');
            const cal = document.getElementById('calendarContainer');
            graph.style.display = view === 'graph' ? 'block' : 'none';
            cal.style.display = view === 'calendar' ? 'block' : 'none';

            if (view === 'graph') renderChart();
            if (view === 'calendar') renderCalendar();

            if (changeNav) updateNavActive(view);
        }

        // === GRAPH ===
        function renderChart() {
            const ctx = document.getElementById('loanChart').getContext('2d');
            const now = new Date();
            const labels = [], data = [], colors = [];

            currentUser.loans.forEach((loan, i) => {
                const end = new Date(loan.endDate.split('-').reverse().join('-'));
                const days = Math.ceil((end - now) / 86400000);
                let col = '#4CAF50';
                if (days <= 2) col = '#F44336';
                else if (days <= 6) col = '#004fff';
                labels.push(`L${i+1}`);
                data.push(loan.takenAmount);
                colors.push(col);
            });

            if (loanChart) loanChart.destroy();
            loanChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ data, backgroundColor: colors, borderColor: '#333', borderWidth: 1 }] },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { grid: { color: '#333' }, ticks: { color: '#aaa' } } },
                    onClick: (e, el) => { if (el.length) showDatePopup(currentUser.loans.indexOf(filteredLoans[el[0].index])); }
                }
            });
        }

        // === CALENDAR ===
        function renderCalendar() {
            const c = document.getElementById('calendarContainer');
            const y = calendarMonth.getFullYear(), m = calendarMonth.getMonth();
            const first = new Date(y, m, 1).getDay();
            const days = new Date(y, m + 1, 0).getDate();
            const today = new Date();
            const todayStr = `${today.getDate()}-${String(today.getMonth()+1).padStart(2,'0')}-${today.getFullYear()}`;

            const dueMap = {};
            currentUser.loans.forEach((l, i) => {
                const [d,m,y] = l.endDate.split('-');
                dueMap[`${d}-${m}-${y}`] = i;
            });

            let html = `<div style="text-align:center;margin:12px 0;">
                <button onclick="prevMonth()" style="background:none;border:none;color:#aaa;font-size:19px;">Previous</button>
                <span style="margin:0 16px;font-weight:600;color:#eee;">${calendarMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}</span>
                <button onclick="nextMonth()" style="background:none;border:none;color:#aaa;font-size:19px;">Next</button>
            </div>
            <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;text-align:center;font-weight:600;color:#888;">
                <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>`;

            for (let i = 0; i < first; i++) html += `<div></div>`;
            for (let d = 1; d <= days; d++) {
                const ds = `${d}-${String(m+1).padStart(2,'0')}-${y}`;
                const isToday = ds === todayStr;
                const idx = dueMap[ds];
                let style = `cursor:${idx!==undefined?'pointer':'default'};`;
                if (isToday) style += `border:2px solid #00aaff;`;
                if (idx !== undefined) {
                    const daysLeft = Math.ceil((new Date(ds.split('-').reverse().join('-')) - today) / 86400000);
                    let bg = '#4CAF50';
                    if (daysLeft <= 2) bg = '#F44336';
                    else if (daysLeft <= 6) bg = '#004fff';
                    style += `background:${bg};color:#000;border-radius:50%;`;
                }
                html += `<div style="${style}" ${idx!==undefined?`onclick="showDatePopup(${idx})"`:''}>${d}</div>`;
            }
            html += `</div>`;
            c.innerHTML = html;
        }

        function prevMonth() { calendarMonth.setMonth(calendarMonth.getMonth() - 1); renderCalendar(); }
        function nextMonth() { calendarMonth.setMonth(calendarMonth.getMonth() + 1); renderCalendar(); }

        // === DATE POPUP ===
        function showDatePopup(idx) {
            const loan = currentUser.loans[idx];
            const now = new Date();
            const end = new Date(loan.endDate.split('-').reverse().join('-'));
            const daysLeft = Math.ceil((end - now) / 86400000);
            const status = daysLeft > 0 ? `${daysLeft} day${daysLeft>1?'s':''} left` : 'Overdue';

            document.getElementById('popupContent').innerHTML = `
                <p><strong>Amount:</strong> ${loan.takenAmount} Rs.</p>
                <p><strong>Purpose:</strong> ${loan.purpose || 'Not set'}</p>
                <p><strong>Taken On:</strong> ${loan.planDate}</p>
                <p><strong>Due:</strong> ${loan.endDate}</p>
                <p><strong>Interest:</strong> ${loan.interest} Rs.</p>
                <p><strong>Status:</strong> <span style="color:${daysLeft<=2?'#F44336':daysLeft<=6?'#004fff':'#4CAF50'}">${status}</span></p>
                <button style='    text-align: center;
    display: flex
;
    justify-content: center;
    align-items: center;
    width: 100%;
' onclick="goToList(${idx})">View Full</button>
            `;
            document.getElementById('datePopup').style.display = 'block';
        }

        function closeDatePopup() { document.getElementById('datePopup').style.display = 'none'; }
        function goToList(idx) { closeDatePopup(); switchView('list', true); displayLoanDetails(currentUser.loans[idx], idx); }

        // === CLOSE MODAL ===
        function closeModal() {
            document.getElementById("userInfoModal").style.display = "none";
            saveUserData();
            currentUser = null;
        }
    </script>
</body>
</html>
